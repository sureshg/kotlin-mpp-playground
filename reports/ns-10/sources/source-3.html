


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>: Coverage Report > ServiceKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: :<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">dev.suresh.routes</a>
</div>

<h1>Coverage Summary for Class: ServiceKt (dev.suresh.routes)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ServiceKt</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/221)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ServiceKt$mediaApiCall$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ServiceKt$respondLogStream$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$10</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$3$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$5$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$5$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$6$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$6$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/80)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ServiceKt$services$9</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/753)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package dev.suresh.routes
&nbsp;
&nbsp;import dev.suresh.JFR
&nbsp;import dev.suresh.http.*
&nbsp;import dev.suresh.lang.*
&nbsp;import dev.suresh.log.RespLogger
&nbsp;import dev.suresh.plugins.custom.CookieSession
&nbsp;import dev.suresh.wasm.wasm
&nbsp;import io.github.oshai.kotlinlogging.KLogger
&nbsp;import io.github.oshai.kotlinlogging.KotlinLogging
&nbsp;import io.ktor.http.*
&nbsp;import io.ktor.server.application.*
&nbsp;import io.ktor.server.http.content.*
&nbsp;import io.ktor.server.plugins.csrf.*
&nbsp;import io.ktor.server.response.*
&nbsp;import io.ktor.server.routing.*
&nbsp;import io.ktor.server.sessions.*
&nbsp;import io.ktor.server.sse.heartbeat
&nbsp;import io.ktor.server.sse.send
&nbsp;import io.ktor.server.sse.sse
&nbsp;import io.ktor.server.websocket.webSocket
&nbsp;import io.ktor.sse.ServerSentEvent
&nbsp;import io.ktor.websocket.Frame
&nbsp;import io.ktor.websocket.readText
&nbsp;import io.ktor.websocket.send
&nbsp;import io.opentelemetry.instrumentation.annotations.WithSpan
&nbsp;import kotlin.time.Duration.Companion.seconds
&nbsp;import kotlinx.coroutines.isActive
&nbsp;import kotlinx.serialization.serializer
&nbsp;
<b class="nc">&nbsp;private val logger = KotlinLogging.logger {}</b>
&nbsp;
&nbsp;fun Routing.services() {
<b class="nc">&nbsp;  get(&quot;/ffm&quot;) { call.respondLogStream { FFM.memoryLayout(this) } }</b>
&nbsp;
<b class="nc">&nbsp;  get(&quot;/vthreads&quot;) { call.respondLogStream { VThread.virtualThreads(this) } }</b>
&nbsp;
<b class="nc">&nbsp;  get(&quot;/jfr&quot;) { call.respondLogStream { JFR.recordingStream(this) } }</b>
&nbsp;
<b class="nc">&nbsp;  get(&quot;/trace&quot;) {</b>
<b class="nc">&nbsp;    call.respond(</b>
<b class="nc">&nbsp;        mapOf(&quot;OpenTelemetry&quot; to BuildConfig.otelInstr, &quot;Image Size&quot; to mediaApiCall().toString()))</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  route(&quot;/session&quot;) {</b>
<b class="nc">&nbsp;    get(&quot;/set&quot;) {</b>
<b class="nc">&nbsp;      call.sessions.set(CookieSession(&quot;${BuildConfig.name}: ${BuildConfig.version}&quot;))</b>
<b class="nc">&nbsp;      call.respondText(&quot;Session created&quot;)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    get {</b>
<b class="nc">&nbsp;      val session = call.sessions.get&lt;CookieSession&gt;()</b>
<b class="nc">&nbsp;      call.respondText(&quot;Current Session: $session&quot;)</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  route(&quot;/csrf&quot;) {</b>
<b class="nc">&nbsp;    install(CSRF) {</b>
<b class="nc">&nbsp;      allowOrigin(&quot;https://localhost:8080&quot;)</b>
<b class="nc">&nbsp;      originMatchesHost()</b>
<b class="nc">&nbsp;      checkHeader(&quot;X-CSRF&quot;) { csrfHeader -&gt;</b>
<b class="nc">&nbsp;        val originHeader = request.headers[HttpHeaders.Origin]</b>
<b class="nc">&nbsp;        csrfHeader == originHeader?.hashCode()?.toString(32)</b>
&nbsp;      }
&nbsp;
<b class="nc">&nbsp;      onFailure { respondText(&quot;Access denied!&quot;, status = HttpStatusCode.Forbidden) }</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    post { call.respondText(&quot;CSRF check passed!&quot;) }</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  wasm()</b>
&nbsp;
<b class="nc">&nbsp;  webSocket(&quot;/chat&quot;) {</b>
<b class="nc">&nbsp;    send(&quot;You are connected!&quot;)</b>
<b class="nc">&nbsp;    for (frame in incoming) {</b>
<b class="nc">&nbsp;      frame as? Frame.Text ?: continue</b>
<b class="nc">&nbsp;      val receivedText = frame.readText()</b>
<b class="nc">&nbsp;      send(&quot;You said: $receivedText&quot;)</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  sse(</b>
<b class="nc">&nbsp;      &quot;/sse&quot;,</b>
&nbsp;      serialize = { typeInfo, data -&gt;
<b class="nc">&nbsp;        val serializer = json.serializersModule.serializer(typeInfo.kotlinType!!)</b>
<b class="nc">&nbsp;        json.encodeToString(serializer, data)</b>
&nbsp;      }) {
<b class="nc">&nbsp;        val name = call.parameters[&quot;name&quot;] ?: &quot;World&quot;</b>
<b class="nc">&nbsp;        var counter = 0</b>
<b class="nc">&nbsp;        while (isActive) {</b>
<b class="nc">&nbsp;          send(Name(&quot;Hello&quot;, &quot;$name ${counter++}&quot;))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        heartbeat {</b>
<b class="nc">&nbsp;          period = 10.seconds</b>
<b class="nc">&nbsp;          event = ServerSentEvent(&quot;heartbeat&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        close()</b>
&nbsp;      }
&nbsp;
<b class="nc">&nbsp;  get(&quot;/no-compression&quot;) {</b>
&nbsp;    // Prevent response body compression
<b class="nc">&nbsp;    call.suppressCompression()</b>
<b class="nc">&nbsp;    call.suppressDecompression()</b>
<b class="nc">&nbsp;    println(call.isDecompressionSuppressed)</b>
<b class="nc">&nbsp;    println(call.isCompressionSuppressed) // true</b>
&nbsp;  }
&nbsp;}
&nbsp;
<b class="nc">&nbsp;@WithSpan suspend fun mediaApiCall() = MediaApiClient().images().size</b>
&nbsp;
&nbsp;suspend fun ApplicationCall.respondLogStream(
<b class="nc">&nbsp;    contentType: ContentType = ContentType.Text.EventStream,</b>
&nbsp;    block: suspend KLogger.() -&gt; Unit
&nbsp;) {
<b class="nc">&nbsp;  respondTextWriter(contentType = contentType) { block(RespLogger(this, logger)) }</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-03-10 00:14</div>
</div>
</body>
</html>
